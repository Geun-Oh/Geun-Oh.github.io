+++
title = 'V8 Isolate 2'
date = 2024-09-17T02:49:30+09:00
draft = false
+++

> 난잡한 지식을 머릿속으로 정렬하고, 순서대로 글에 적습니다.

v8 isolate는 v8엔진의 기능 중 하나로, v8 자체를 복제하여 별도의 독립된 Javascript 실행 환경을 제공하는 기능입니다.

해당 기능은 별도의 heap 메모리 공간, 별도의 garbage collector 등 격리된 환경을 조성하게 된다는 것에 매우 큰 장점을 가집니다.
Javascript에서 비동기 제어를 위해 동작하는 Event Loop 및 Call Stack 또한 별도로 가지게 됩니다.
이러한 컨셉을 통해 우리는 단일 스레드에서도 격리된 환경을 조성하여 javascript 코드 번들을 실행할 수 있습니다.

일반적으로는 격리된 환경 조성을 위해서는 새로운 환경 초기화가 필수적으로 다가옵니다.
혹은 타 언어의 경량 스레드를 사용하게 되는 상황이라면 GC를 공유하거나, 메모리 독립적이지 못하는 경우가 있습니다.

v8-isolate를 사용하는 것은 이러한 단점을 충분히 보완해주며, 아주 작은 오버헤드로 격리된 환경을 조성할 수 있도록 돕습니다.

이는 단일 스레드에서 실행되는 독립적인 비동기 작업들에 대해 안정성을 보장해주며, 추가적인 보안 조치 등을 수행하여 온전한 격리 공간을 조성할 수 있습니다.

v8-isolate에서는 메모리 제한을 걸 수 있지만, CPU 점유율을 조정할 수 없습니다.

따라서 우리는 이러한 단점을 cgroup을 통해 조정하며 격리 환경에 견고함을 더할 수 있습니다.

혹은, 실제 운영체제 단에서의 스레드를 생성하여 CPU 점유율을 명확하게 관리하고, 병렬처리를 진행할 수 있습니다.

헷갈리는 부분을 조금 더 정리하면 다음과 같다.

1. 싱글 스레드 환경에서 여러 v8-isolate를 생성하여 비동기 작업을 처리하는 것은 격리된 환경 조성에 탁월하다.
- v8-isolate는 독립적인 힙과 실행 컨텍스트를 가지므로, 여러 isolate가 하나의 스레드에서 동작하고 있을 때에도 서로 상태나 메모리에 영향을 주지 않는다.

2. 이 경우 v8-isoalte에 대한 스케쥴링은 부모 스레드에서 담당한다.
- 여러 isolate가 있을 때, 이 isolate들이 어떤 순서로 또는 어떤 방식으로 실행될지에 대한 결정은 해당 isolate를 실행하는 스레드에 달려 있다.
- 부모 스레드는 각 isolate 작업을 스케쥴링하고, 필요 시 작업 교체 및 종료를 진행한다.

3. v8-isolate는 각각 독립적인 실행 컨텍스트를 가지지만, 이벤트 루프와 같이 스케쥴링은 부모가 진행한다.
- 각 isolate는 자체적인 실행 context(힙과 스택)를 가지지만, 이벤트 루프나 스케쥴링과 관련한 작업은 부모 스레드에서 이뤄진다.
- 멀티 스레딩 환경에서는 각각이 부모 스레드 없이 동작하기 때문에 각각의 런타임에서 스케쥴링을 진행한다.
- 또한 비동기 작업의 경우, v8자체의 이벤트 루프나 외부 작업 큐와 연계하여 비동기 작업을 수행한다.